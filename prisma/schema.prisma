generator client {
  provider = "prisma-client-js"
  
}
datasource db {
  provider = "postgresql"
}

model batches {
  batch_id          Int            @id @default(autoincrement())
  batch_no          String         @unique @db.VarChar(50)
  product_id        Int
  quantity_produced Int
  manufactured_date DateTime       @db.Date
  expiry_date       DateTime       @db.Date
  products          products       @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  outlet_stock      outlet_stock[]
  sale_items        sale_items[]
  wastage           wastage[]
}

model customer_order_items {
  order_item_id   Int             @id @default(autoincrement())
  order_id        Int
  product_id      Int
  quantity        Int
  unit_price      Decimal         @db.Decimal(10, 2)
  customer_orders customer_orders @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
  products        products        @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
}

model customer_orders {
  order_id              Int                     @id @default(autoincrement())
  customer_id           Int
  outlet_id             Int
  order_date            DateTime?               @default(now()) @db.Timestamp(6)
  pickup_date           DateTime                @db.Date
  status                order_status            @default(PENDING)
  total_amount          Decimal                 @db.Decimal(10, 2)
  special_instructions  String?
  customer_order_items  customer_order_items[]
  customers             customers               @relation(fields: [customer_id], references: [customer_id], onDelete: NoAction, onUpdate: NoAction)
  outlets               outlets                 @relation(fields: [outlet_id], references: [outlet_id], onDelete: NoAction, onUpdate: NoAction)
  payments              payments[]
  restock_request_items restock_request_items[]
}

model customers {
  customer_id     Int               @id @default(autoincrement())
  user_id         Int               @unique
  first_name      String            @db.VarChar(50)
  last_name       String            @db.VarChar(50)
  contact_no      String?           @db.VarChar(20)
  address         String?
  loyalty_points  Int?              @default(0)
  customer_orders customer_orders[]
  users           users             @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  sales           sales[]
}

model daily_restock_requests {
  request_id            Int                     @id @default(autoincrement())
  outlet_id             Int
  generated_at          DateTime?               @default(now()) @db.Timestamp(6)
  required_for_date     DateTime                @db.Date
  status                restock_status          @default(GENERATED)
  outlets               outlets                 @relation(fields: [outlet_id], references: [outlet_id], onDelete: NoAction, onUpdate: NoAction)
  restock_request_items restock_request_items[]
}

model employees {
  employee_id       Int               @id @default(autoincrement())
  user_id           Int               @unique
  first_name        String            @db.VarChar(50)
  last_name         String            @db.VarChar(50)
  nic               String            @unique @db.VarChar(20)
  contact_no        String?           @db.VarChar(20)
  hire_date         DateTime          @db.Date
  employment_status employment_status @default(ACTIVE)
  outlet_id         Int?
  outlets           outlets?          @relation(fields: [outlet_id], references: [outlet_id], onDelete: NoAction, onUpdate: NoAction)
  users             users             @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  sales             sales[]
  wastage           wastage[]
}

model outlet_stock {
  stock_id            Int       @id @default(autoincrement())
  outlet_id           Int
  batch_id            Int
  current_quantity    Int       @default(0)
  minimum_stock_level Int?      @default(10)
  last_updated        DateTime? @default(now()) @db.Timestamp(6)
  status              String?   @db.VarChar(255)
  batches             batches   @relation(fields: [batch_id], references: [batch_id], onDelete: NoAction, onUpdate: NoAction)
  outlets             outlets   @relation(fields: [outlet_id], references: [outlet_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([outlet_id, batch_id])
}

model outlets {
  outlet_id              Int                      @id @default(autoincrement())
  outlet_name            String                   @db.VarChar(100)
  location               String
  contact_no             String?                  @db.VarChar(20)
  opening_time           DateTime?                @db.Time(6)
  closing_time           DateTime?                @db.Time(6)
  is_active              Boolean?                 @default(true)
  customer_orders        customer_orders[]
  daily_restock_requests daily_restock_requests[]
  employees              employees[]
  outlet_stock           outlet_stock[]
  sales                  sales[]
  wastage                wastage[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model payments {
  payment_id        Int              @id @default(autoincrement())
  sale_id           Int?
  customer_order_id Int?
  amount            Decimal          @db.Decimal(10, 2)
  payment_method    payment_method
  payment_status    payment_status   @default(PENDING)
  reference_no      String?          @db.VarChar(100)
  payment_date      DateTime?        @default(now()) @db.Timestamp(6)
  customer_orders   customer_orders? @relation(fields: [customer_order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction)
  sales             sales?           @relation(fields: [sale_id], references: [sale_id], onDelete: NoAction, onUpdate: NoAction)
}

model permissions {
  permission_id    Int                @id @default(autoincrement())
  permission_slug  String             @unique @db.VarChar(100)
  description      String?
  role_permissions role_permissions[]
}

model products {
  product_id            Int                     @id @default(autoincrement())
  product_name          String                  @db.VarChar(100)
  description           String?
  category              String?                 @db.VarChar(50)
  base_price            Decimal                 @db.Decimal(10, 2)
  shelf_life_days       Int
  measurement_type      measurement_type
  is_active             Boolean?                @default(true)
  batches               batches[]
  customer_order_items  customer_order_items[]
  restock_request_items restock_request_items[]
}

model restock_request_items {
  req_item_id              Int                    @id @default(autoincrement())
  request_id               Int
  product_id               Int
  quantity                 Int
  linked_customer_order_id Int?
  customer_orders          customer_orders?       @relation(fields: [linked_customer_order_id], references: [order_id], onUpdate: NoAction)
  products                 products               @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  daily_restock_requests   daily_restock_requests @relation(fields: [request_id], references: [request_id], onDelete: Cascade, onUpdate: NoAction)
}

model role_permissions {
  role_id       Int
  permission_id Int
  permissions   permissions @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [role_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([role_id, permission_id])
}

model roles {
  role_id          Int                @id @default(autoincrement())
  role_name        role_type          @unique
  description      String?
  role_permissions role_permissions[]
  users            users[]
}

model sale_items {
  sale_item_id Int     @id @default(autoincrement())
  sale_id      Int
  batch_id     Int
  quantity     Int
  unit_price   Decimal @db.Decimal(10, 2)
  subtotal     Decimal @db.Decimal(10, 2)
  batches      batches @relation(fields: [batch_id], references: [batch_id], onDelete: NoAction, onUpdate: NoAction)
  sales        sales   @relation(fields: [sale_id], references: [sale_id], onDelete: Cascade, onUpdate: NoAction)
}

model sales {
  sale_id         Int          @id @default(autoincrement())
  bill_no         String       @unique @db.VarChar(50)
  outlet_id       Int
  employee_id     Int?
  customer_id     Int?
  sale_date       DateTime?    @default(now()) @db.Timestamp(6)
  total_amount    Decimal      @db.Decimal(10, 2)
  discount_amount Decimal?     @default(0.00) @db.Decimal(10, 2)
  net_amount      Decimal      @db.Decimal(10, 2)
  status          sale_status  @default(COMPLETED)
  payments        payments[]
  sale_items      sale_items[]
  customers       customers?   @relation(fields: [customer_id], references: [customer_id], onDelete: NoAction, onUpdate: NoAction)
  employees       employees?   @relation(fields: [employee_id], references: [employee_id], onDelete: NoAction, onUpdate: NoAction)
  outlets         outlets      @relation(fields: [outlet_id], references: [outlet_id], onDelete: NoAction, onUpdate: NoAction)
}

model users {
  user_id       Int        @id @default(autoincrement())
  username      String     @unique @db.VarChar(50)
  password_hash String     @db.VarChar(255)
  email         String?    @unique @db.VarChar(100)
  role_id       Int
  created_at    DateTime?  @default(now()) @db.Timestamp(6)
  is_active     Boolean?   @default(true)
  customers     customers?
  employees     employees?
  roles         roles      @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction)
}

model wastage {
  wastage_id              Int            @id @default(autoincrement())
  outlet_id               Int
  batch_id                Int
  quantity                Int
  reason                  wastage_reason
  recorded_by_employee_id Int?
  recorded_at             DateTime?      @default(now()) @db.Timestamp(6)
  notes                   String?
  batches                 batches        @relation(fields: [batch_id], references: [batch_id], onDelete: NoAction, onUpdate: NoAction)
  outlets                 outlets        @relation(fields: [outlet_id], references: [outlet_id], onDelete: NoAction, onUpdate: NoAction)
  employees               employees?     @relation(fields: [recorded_by_employee_id], references: [employee_id], onDelete: NoAction, onUpdate: NoAction)
}

enum employment_status {
  ACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

enum measurement_type {
  PCS
  KG
  BOX
  LITRE
}

enum order_status {
  PENDING
  PREPARING
  READY_FOR_PICKUP
  COMPLETED
  CANCELLED
  DISPATCHED
}

enum payment_method {
  CASH
  CARD
  ONLINE_TRANSFER
}

enum payment_status {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum restock_status {
  GENERATED
  SENT_TO_FACTORY
  DISPATCHED
  RECEIVED
}

enum role_type {
  ADMIN
  MANAGER
  SALESPERSON
  FACTORY_DISTRIBUTOR
  CUSTOMER
}

enum sale_status {
  COMPLETED
  REFUNDED
}

enum wastage_reason {
  EXPIRED_AUTOMATIC
  DAMAGED_IN_STORE
  PRODUCTION_FAILURE
  OTHER
}
